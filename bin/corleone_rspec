#!/usr/bin/env ruby

require 'corleone'
require 'corleone/rspec'

Corleone.logger.level = Logger::INFO

if ENV['DEBUG']
  Corleone.logger.level = Logger::DEBUG
end

SERVER_URI = ENV['SERVER_URI'] || 'druby://0.0.0.0:7000'

# start server
collector = Corleone::Collector::RSpec.new
emitter = Corleone::Emitter::RSpec.new(ARGV, (ENV['WORKERS'] || 1).to_i)
server = Corleone::Server.new(emitter, collector, SERVER_URI)
server.start

# run loop
loop { server.alive? ? Kernel.sleep(1) : break }
server.summarize
