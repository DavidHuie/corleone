#!/usr/bin/env ruby

require 'docker_test'
require 'docker_test/emitter/rspec'

SERVER_URI = 'druby://0.0.0.0:7000'

config_file = ARGV.shift

# start server
emitter = DockerTest::Emitter::RSpec.new(ARGV)
server = DockerTest::Server.new(emitter, SERVER_URI)
server.start

# launch containers
config = DockerTest::Config.new
config.instance_eval(File.read(config_file), config_file)
config.image.create_linked_containers
config.image.create_container

begin
  loop { server.alive? ? sleep(1) : break }
ensure
  config.image.kill
  config.image.kill_linked
end
